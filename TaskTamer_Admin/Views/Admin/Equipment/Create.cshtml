@using TaskTamer_Application.Contracts
@model EquipmentDTO

@{
    ViewData["Title"] = "Добавление оборудования";
}

<div class="container mt-4">
    <h2>Добавление нового оборудования</h2>
    <hr />
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-@TempData["messageType"] alert-dismissible fade show mt-3" role="alert">
            @TempData["ErrorMessage"]
        </div>
    }
    <form asp-action="Create" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        @Html.AntiForgeryToken()

        <div class="row">
            <!-- Левая колонка - Основная информация -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-info-circle"></i> Основная информация
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label asp-for="Name" class="form-label">Название *</label>
                            <input asp-for="Name" class="form-control" required
                                   placeholder="Например: Рабочая станция IT-001" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Model" class="form-label">Модель *</label>
                            <input asp-for="Model" class="form-control" required
                                   placeholder="Например: ThinkCentre M90a" />
                            <span asp-validation-for="Model" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="SerialNumber" class="form-label">Серийный номер *</label>
                            <input asp-for="SerialNumber" class="form-control" required
                                   placeholder="Например: SN123456789" />
                            <span asp-validation-for="SerialNumber" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Type" class="form-label">Тип оборудования *</label>
                            <select asp-for="Type" class="form-control" required>
                                <option value="">-- Выберите тип --</option>
                                <option value="Компьютер">Компьютер</option>
                                <option value="Ноутбук">Ноутбук</option>
                                <option value="Монитор">Монитор</option>
                                <option value="Принтер">Принтер</option>
                                <option value="Сканер">Сканер</option>
                                <option value="Сервер">Сервер</option>
                                <option value="Сетевое">Сетевое оборудование</option>
                                <option value="Телефон">Телефон</option>
                                <option value="Офисное">Офисное оборудование</option>
                                <option value="Другое">Другое</option>
                            </select>
                            <span asp-validation-for="Type" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Manufacturer" class="form-label">Производитель</label>
                            <input asp-for="Manufacturer" class="form-control"
                                   placeholder="Например: Lenovo, HP, Dell" />
                            <span asp-validation-for="Manufacturer" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="PurchaseDate" class="form-label">Дата покупки</label>
                            <input asp-for="PurchaseDate" type="date" class="form-control"
                                   max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            <span asp-validation-for="PurchaseDate" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Правая колонка - Расположение и документация -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-map-marker-alt"></i> Расположение и ответственные
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label asp-for="Location" class="form-label">Местоположение *</label>
                            <input asp-for="Location" class="form-control" required
                                   placeholder="Например: Кабинет 301, Стеллаж А5" />
                            <span asp-validation-for="Location" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="departmentDTO.DepartmentID" class="form-label">Отдел</label>
                            <select asp-for="departmentDTO.DepartmentID" class="form-control"
                                    asp-items="ViewBag.Departments" >
                                <option value="">-- Выберите отдел --</option>
                            </select>
                            <span asp-validation-for="departmentDTO.DepartmentID" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="ResponsibleEmployee.EmployeeID" class="form-label">Ответственный сотрудник</label>
                            <select asp-for="ResponsibleEmployee.EmployeeID" class="form-control"
                                    asp-items="ViewBag.ResponsibleEmployees" disabled>
                                <option value="">-- Выберите ответственного --</option>
                            </select>
                            <span asp-validation-for="ResponsibleEmployee.EmployeeID" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-file-pdf"></i> Техническая документация
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label class="form-label">Загрузить документацию</label>
                            <input type="file" name="documentationFile" class="form-control"
                                   id="documentationFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png, .txt" />
                            <small class="form-text text-muted">
                                Поддерживаемые форматы: TXT, PDF, Word, Excel, изображения (макс. 10MB)
                            </small>
                            <div id="filePreview" class="mt-2" style="display: none;">
                                <span class="badge bg-info" id="fileName"></span>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2"
                                        onclick="clearFileInput()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="form-group mt-4">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-plus"></i> Создать оборудование
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад к списку
            </a>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Предпросмотр имени файла
        document.getElementById('documentationFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                if (fileSize > 10) {
                    alert('Файл слишком большой! Максимальный размер: 10MB');
                    this.value = '';
                    return;
                }

                document.getElementById('fileName').textContent = file.name + ` (${fileSize} MB)`;
                document.getElementById('filePreview').style.display = 'block';

                // Очищаем поле URL если загружаем файл
                document.getElementById('TechnicalDocumentation').value = '';
            }
        });

        function clearFileInput() {
            document.getElementById('documentationFile').value = '';
            document.getElementById('filePreview').style.display = 'none';
        }

        // Валидация формы
        (function () {
            'use strict';
            window.addEventListener('load', function () {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        // Проверяем что хотя бы одно из полей документации заполнено
                        const fileInput = document.getElementById('documentationFile');
                        const urlInput = document.getElementById('TechnicalDocumentation');

                        if (!fileInput.value && !urlInput.value) {
                            // Не требуем документацию, но можно добавить проверку если нужно
                            // alert('Заполните хотя бы одно поле документации');
                            // event.preventDefault();
                        }

                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // Автозаполнение текущей даты при фокусе на поле даты покупки
        document.getElementById('PurchaseDate').addEventListener('focus', function() {
            if (!this.value) {
                this.value = new Date().toISOString().split('T')[0];
            }
        });
    </script>

    <style>
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid #dee2e6;
        }

        .card-header {
            font-weight: 600;
        }

        .form-label {
            font-weight: 500;
            color: #495057;
        }

        .btn {
            border-radius: 0.375rem;
        }

        #filePreview {
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            border: 1px dashed #dee2e6;
        }
    </style>
}
